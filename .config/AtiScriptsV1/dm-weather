#!/usr/bin/env bash
#
# Script name: dm-weather
# Description: Weather notification (short format + cache)
# Dependencies: dmenu, curl, dunst

set -euo pipefail

# shellcheck disable=SC1091
source ./_dm-helper.sh 2>/dev/null || source _dm-helper.sh 2>/dev/null

source_dmscripts_configs

if configs_are_different; then
  echo "$(date): configs are different" >>"$DM_CONFIG_DIFF_LOGFILE"
  sleep 1
fi

main() {
  # shellcheck disable=SC2154
  _location="$(printf '%s\n' "${weather_locations}" | ${MENU} "Where do you want to see the weather?")"
  [[ -z "$_location" ]] && exit 0

  # Cache config
  cache_dir="/tmp/dm-weather"
  mkdir -p "$cache_dir"

  cache_file="$cache_dir/${_location// /_}"
  cache_ttl=3600 # 1 hour

  if [[ -f "$cache_file" ]] && (($(date +%s) - $(stat -c %Y "$cache_file") < cache_ttl)); then
    weather="$(cat "$cache_file")"
  else
    weather="$(curl -s "https://wttr.in/${_location// /%20}?format=3")"
    echo "$weather" >"$cache_file"
  fi

  dunstify \
    -a "Weather" \
    -u normal \
    -t 8000 \
    "$_location" \
    "$weather"
}

MENU="$(get_menu_program "$@")"
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main

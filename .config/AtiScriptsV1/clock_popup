#!/bin/bash

# -----------------------------------------------------------------------------
# CONFIGURATION (user-based ATITODOS directory)
# -----------------------------------------------------------------------------

# Username ‚Üí uppercase (ati ‚Üí ATI)
USER_NAME="$(whoami | tr '[:lower:]' '[:upper:]')"

# Folder ‚Üí ATITODOS, SUSUTODOS, etc.
TODOS_DIR="$HOME/${USER_NAME}TODOS"

TODO_FILE="$TODOS_DIR/todos.md"

# Create directory & file if missing
mkdir -p "$TODOS_DIR"
touch "$TODO_FILE"

# -----------------------------------------------------------------------------
# DATE INFO
# -----------------------------------------------------------------------------

today=$(date "+%Y-%m-%d")
header=$(date "+%A, %d %B %Y")

process_tasks() {
  mode="$1"
  awk -v mode="$mode" '
        # Function: deterministic color based on tag name
        function tag_color(tag,   sum, i, c, r, g, b) {
            sum = 0
            for (i=1; i<=length(tag); i++) {
                c = ord(substr(tag,i,1))
                sum += c * i
            }
            r = (sum * 53) % 256
            g = (sum * 97) % 256
            b = (sum * 193) % 256
            return sprintf("#%02X%02X%02X", r, g, b)
        }
        # Function: get ASCII code of character
        function ord(c) { return sprintf("%d", index("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789", c)) }
        {
            prio = 2
            line = $0
            color = ""
            if (match(line, /@Color\([^)]+\)/)) {
                color_tag = substr(line, RSTART, RLENGTH)
                sub(/@Color\([^)]+\)/, "", line)
                color = color_tag
                gsub(/@Color\(|\)/, "", color)
            }
            if (sub(/@Prio\(high\)/, "(High)", line)) { prio = 1 }
            else if (sub(/@Prio\(low\)/, "(Low)", line)) { prio = 3 }
            else if (sub(/@Prio\(normal\)/, "(Normal)", line)) { prio = 2 }
            
            tag_html = ""
            while (match(line, /@Tag\([^)]+\)/)) {
                full_tag = substr(line, RSTART, RLENGTH)
                tag_name = full_tag
                gsub(/@Tag\(|\)/,"",tag_name)
                tag_html = tag_html "<span foreground=\"" tag_color(tag_name) "\">#" tag_name "</span> "
                line = substr(line,1,RSTART-1) substr(line,RSTART+RLENGTH)
            }
            sub(/- \[.?\] */, "", line)
            sub(/ *@([0-9]{4}-[0-9]{2}-[0-9]{2}).*/, "", line)
            gsub(/^[ \t]+|[ \t]+$/, "", line)
            box = (mode=="done") ? "  - [x] " : "  - [  ] "
            final_line = box line " " tag_html
            if (color != "") { final_line = "<span foreground=\"" color "\">" final_line "</span>" }
            print prio "|" final_line
        }' | sort -n | cut -d'|' -f2-
}

highlight_priority() {
  sed -e 's/(High)/<span foreground=\"#FF6B6B\">(High)<\/span>/g' \
    -e 's/(Low)/<span foreground=\"#FFD580\">(Low)<\/span>/g' \
    -e 's/(Normal)/<span foreground=\"#ffffff\">(Normal)<\/span>/g'
}

due_today=$(grep "\[ \].*@${today}" "$TODO_FILE" | process_tasks "undone" | highlight_priority)
done_today=$(grep "\[x\].*@${today}" "$TODO_FILE" | process_tasks "done" | highlight_priority)
general=$(awk -v d="$today" '/- \[ \] .*@([0-9]{4}-[0-9]{2}-[0-9]{2})/ { match($0, /@([0-9]{4}-[0-9]{2}-[0-9]{2})/, a); if (a[1] < d) print $0; }' "$TODO_FILE" | process_tasks | shuf | head -n 4 | highlight_priority)

future=$(
  awk -v d="$today" '/- \[ \] .*@([0-9]{4}-[0-9]{2}-[0-9]{2})/ {match($0, /@([0-9]{4}-[0-9]{2}-[0-9]{2})/, a);if (a[1] > d) print $0;}' "$TODO_FILE" | process_tasks | shuf | head -n 4 | highlight_priority
)

[ -z "$due_today" ] && due_today="<i>  (No tasks due today)</i>"
[ -z "$done_today" ] && done_today="<i>  (No tasks completed today)</i>"
[ -z "$general" ] && general="<i>  (No overdue tasks)</i>"
[ -z "$future" ] && future="<i>(No future tasks)</i>"

notify-send -u low -h string:markup:1 -t 40000 \
  "what is the plan Today?" \
  "<b><span foreground='#ffffff'>$header</span></b>
<b><span >------------------------------------------------------</span></b>
<b><span foreground='#ffffff'>üóìÔ∏è Due Today:</span></b>
<b><span >$due_today</span></b>
<b><span >------------------------------------------------------</span></b>
<b><span foreground='#c678dd'>‚úÖ Done Today:</span></b>
<b><span foreground='#70D78F'>$done_today</span></b>
<b><span >------------------------------------------------------</span></b>
<b><span foreground='#FF6B6B'>üìù General (Past Due):</span></b>
<b><span foreground='#ffffff' >$general</span></b>
<b><span >------------------------------------------------------</span></b>
<b><span foreground='#98c379' >‚è≥ Future Tasks:</span></b>
<b><span foreground='#ffffff' >$future</span></b>"

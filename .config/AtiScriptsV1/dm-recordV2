#!/usr/bin/env bash

# Script name: dm-record
# Description: Menu script to record video, audio, webcam, gif.
# Dependencies: ffmpeg, pulseaudio, alsa, slop (for area selection), libnotify (for notify-send), rofi/dmenu(optional)

set -euo pipefail

# Configuration
record_dir="${record_dir:-$HOME/Videos/Recordings}"
mkdir -p "$record_dir"

# Notification wrapper
notify() {
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "dm-record" "$1"
  fi
  echo "$1"
}

# Detect menu program
get_menu_command() {
  if command -v rofi >/dev/null 2>&1; then
    echo "rofi -dmenu -i -p"
  elif command -v dmenu >/dev/null 2>&1; then
    echo "dmenu -i -l 10 -p"
  else
    echo "text"
  fi
}
MENU="$(get_menu_command)"

# Stop recording
stop_recording() {
  if [[ -f /tmp/recordingpid ]]; then
    recpid="$(cat /tmp/recordingpid)"
    kill -15 "$recpid" 2>/dev/null || true
    rm -f /tmp/recordingpid
    sleep 1
    kill -9 "$recpid" 2>/dev/null || true
    notify "Recording stopped"
  else
    notify "No active recording found"
  fi
}

# Record full screen + audio
record_screen_audio() {
  output="$record_dir/screen-audio-$(date '+%y%m%d-%H%M-%S').mp4"
  ffmpeg -y -f x11grab -framerate 30 \
    -s "$(xdpyinfo | awk '/dimensions/ {print $2;}')" \
    -i "$DISPLAY" \
    -f pulse -i default \
    -c:v libx264 -crf 23 -preset fast \
    -c:a aac "$output" &
  echo $! >/tmp/recordingpid
  notify "Screen + Audio recording started → $output"
}

# Record full screen (video only)
record_screen() {
  output="$record_dir/screen-only-$(date '+%y%m%d-%H%M-%S').mp4"
  ffmpeg -y -f x11grab -framerate 30 \
    -s "$(xdpyinfo | awk '/dimensions/ {print $2;}')" \
    -i "$DISPLAY" \
    -c:v libx264 -crf 23 -preset fast "$output" &
  echo $! >/tmp/recordingpid
  notify "Screen recording started → $output"
}

# Record selected area (video only)
record_area() {
  if ! command -v slop >/dev/null 2>&1; then
    notify "Error: 'slop' required but not installed."
    exit 1
  fi

  notify "Click and drag to select area"
  if ! selection=$(slop -f "%x %y %w %h" --nokeyboard 2>&1); then
    notify "Selection cancelled"
    exit 0
  fi
  read -r X Y W H <<<"$selection"

  if [[ -z "$X" || -z "$Y" || -z "$W" || -z "$H" || $W -lt 50 || $H -lt 50 ]]; then
    notify "Invalid selection"
    exit 1
  fi

  output="$record_dir/screen-area-$(date '+%y%m%d-%H%M-%S').mp4"
  ffmpeg -y -f x11grab -framerate 30 \
    -video_size "${W}x${H}" -i "${DISPLAY}+${X},${Y}" \
    -c:v libx264 -crf 23 -preset fast "$output" &
  echo $! >/tmp/recordingpid
  notify "Screen area recording started → $output"
}

# Record selected area as GIF
record_area_gif() {
  command -v slop >/dev/null || {
    notify "slop not installed"
    exit 1
  }

  notify "Select area for GIF"

  if ! selection=$(slop -f "%x %y %w %h" --nokeyboard); then
    notify "Selection cancelled"
    exit 0
  fi

  read -r X Y W H <<<"$selection"

  if ! [[ "$X" =~ ^[0-9]+$ && "$Y" =~ ^[0-9]+$ &&
    "$W" =~ ^[0-9]+$ && "$H" =~ ^[0-9]+$ ]] ||
    ((W <= 0 || H <= 0)); then
    notify "Invalid selection"
    exit 1
  fi

  output="$record_dir/screen-area-$(date '+%y%m%d-%H%M-%S').gif"

  ffmpeg -y -f x11grab -framerate 15 \
    -video_size "${W}x${H}" -i "${DISPLAY}+${X},${Y}" \
    -vf "fps=15,scale=iw:-1:flags=lanczos" \
    "$output" &

  echo $! >/tmp/recordingpid
  notify "GIF recording started → press key again to stop"
}

# Record audio only
record_audio() {
  output="$record_dir/audio-$(date '+%y%m%d-%H%M-%S').mp3"
  ffmpeg -y -f alsa -i default \
    -c:a libmp3lame -qscale:a 2 "$output" &
  echo $! >/tmp/recordingpid
  notify "Audio recording started → $output"
}

# Record webcam (low resolution)
record_webcam_low() {
  if [[ ! -e /dev/video0 ]]; then
    notify "Error: No webcam found at /dev/video0"
    exit 1
  fi
  output="$record_dir/webcam-low-$(date '+%y%m%d-%H%M-%S').mp4"
  ffmpeg -y -f v4l2 -i /dev/video0 -video_size 640x480 \
    -c:v libx264 "$output" &
  echo $! >/tmp/recordingpid
  notify "Webcam (low-res) recording started → $output"
}

# Record webcam (HD)
record_webcam_hd() {
  if [[ ! -e /dev/video0 ]]; then
    notify "Error: No webcam found at /dev/video0"
    exit 1
  fi
  output="$record_dir/webcam-hd-$(date '+%y%m%d-%H%M-%S').mp4"
  ffmpeg -y -f v4l2 -i /dev/video0 -video_size 1920x1080 \
    -c:v libx264 "$output" &
  echo $! >/tmp/recordingpid
  notify "Webcam (HD) recording started → $output"
}

# Menu
askrecording() {
  if [ "$MENU" = "text" ]; then
    echo "Select recording mode:"
    echo "1) Screen + Audio (full display)"
    echo "2) Screen Only (full display)"
    echo "3) Screen Area (selection)"
    echo "4) Audio Only"
    echo "5) Webcam (low-res 640x480)"
    echo "6) Webcam (HD 1920x1080)"
    echo "7) GIF (screen area)"
    read -rp "Choice [1-7]: " choice
    case $choice in
    1) record_screen_audio ;;
    2) record_screen ;;
    3) record_area ;;
    4) record_audio ;;
    5) record_webcam_low ;;
    6) record_webcam_hd ;;
    7) record_area_gif ;;
    *)
      notify "Invalid choice"
      exit 1
      ;;
    esac
  else
    choice=$(printf "Screen + Audio (full display)\\nScreen Only (full display)\\nScreen Area (selection)\\nAudio Only\\nWebcam (low-res 640x480)\\nWebcam (HD 1920x1080)\\nGIF (screen area)" | ${MENU} "Select recording mode:")
    case "$choice" in
    "Screen + Audio (full display)") record_screen_audio ;;
    "Screen Only (full display)") record_screen ;;
    "Screen Area (selection)") record_area ;;
    "Audio Only") record_audio ;;
    "Webcam (low-res 640x480)") record_webcam_low ;;
    "Webcam (HD 1920x1080)") record_webcam_hd ;;
    "GIF (screen area)") record_area_gif ;;
    *)
      notify "No selection made"
      exit 0
      ;;
    esac
  fi
}

main() {
  if ! command -v ffmpeg >/dev/null 2>&1; then
    notify "Error: ffmpeg required but not installed."
    exit 1
  fi

  # If recording already active → stop immediately
  if [[ -f /tmp/recordingpid ]] && ps -p "$(cat /tmp/recordingpid)" >/dev/null 2>&1; then
    stop_recording
  else
    askrecording
  fi
}

main "$@"

#!/usr/bin/env bash
#
# Script name: dm-confedit
# Description: Dual-branch config browser for ~/.config and ~/.dotfiles
# Dependencies: rofi, nvim, libnotify, kitty

set -euo pipefail

# --- Configuration ---
RMENU="rofi -dmenu -i -p"
DMEDITOR="kitty -e nvim"
CONFIG_DIR="$HOME/.config"
DOTFILES_DIR="$HOME/.dotfiles" # Ensure this matches your actual path
SEPARATOR="‚ûú"

# File patterns to exclude (case insensitive)
EXCLUDE_PATTERNS=(
  "*.jpg" "*.jpeg" "*.png" "*.gif" "*.webp" "*.mp4" "*.avi" "*.mov" "*.mkv"
  "*.mp3" "*.wav" "*.ogg" "*.flac" "*.zip" "*.tar" "*.gz" "*.rar" "*.7z"
  "*.pdf" "*.doc" "*.docx" "*.iso" "*.bak" "*.tmp" "*.swp" "*.swo"
  "*.log" "*.lock" "*.db" "*.sqlite" "*.cache" "*.old" "*.bin" "*.exe"
  "*.class" "*.pyc" "*.so" ".DS_Store" "*.out" "*.crt" "*.pem" "*.key"
  ".git" ".github" "node_modules"
)

main() {
  local current_dir="ROOT" # Start at a virtual root
  local navigation_stack=()

  while true; do
    local items=()
    local dirs=()
    local files=()

    if [[ "$current_dir" == "ROOT" ]]; then
      # Virtual Root Menu
      items=("1. üìÅ Config (~/.config)" "2. üìÅ Dotfiles (~/.dotfiles)")
      local relative_path="HOME"
    else
      # 1. Find directories (Follows symlinks with -L)
      while IFS= read -r -d '' dir; do
        [[ "$dir" == "$current_dir" ]] && continue
        dirs+=("${dir##*/}/")
      done < <(find -L "$current_dir" -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null | sort -z)

      # 2. Find files (Follows symlinks with -L)
      while IFS= read -r -d '' file; do
        local filename="${file##*/}"
        local exclude_file=0
        for pattern in "${EXCLUDE_PATTERNS[@]}"; do
          if [[ "${filename,,}" == ${pattern,,} ]]; then
            exclude_file=1
            break
          fi
        done
        [[ $exclude_file -eq 0 ]] && files+=("$filename")
      done < <(find -L "$current_dir" -mindepth 1 -maxdepth 1 -type f -print0 2>/dev/null | sort -z)

      items=("${dirs[@]}" "${files[@]}")

      # Breadcrumb display
      local relative_path="${current_dir#$HOME/}"
      # Add "Back" option
      items=("../" "${items[@]}")
    fi

    # Show Menu
    local choice
    choice=$(printf '%s\n' "${items[@]}" | $RMENU "Browse ${SEPARATOR} ${relative_path}:")

    # Handle ESC/Exit
    if [[ -z "$choice" ]]; then
      if [[ ${#navigation_stack[@]} -gt 0 ]]; then
        current_dir="${navigation_stack[-1]}"
        unset 'navigation_stack[-1]'
        continue
      else
        exit 0
      fi
    fi

    case "$choice" in
    "1. üìÅ Config (~/.config)")
      navigation_stack+=("ROOT")
      current_dir="$CONFIG_DIR"
      ;;
    "2. üìÅ Dotfiles (~/.dotfiles)")
      navigation_stack+=("ROOT")
      current_dir="$DOTFILES_DIR"
      ;;
    "../")
      current_dir="${navigation_stack[-1]}"
      unset 'navigation_stack[-1]'
      ;;
    */)
      # Enter Directory
      navigation_stack+=("$current_dir")
      current_dir="${current_dir}/${choice%/}"
      ;;
    *)
      # Open File
      local target_file="${current_dir}/${choice}"

      # Resolve real path to fix Neovim syntax highlighting
      local real_path
      real_path=$(readlink -f "$target_file")

      if [[ -f "$real_path" ]]; then
        $DMEDITOR "$real_path"
        exit 0
      else
        notify-send "Error" "File '$choice' is no longer accessible."
      fi
      ;;
    esac
  done
}

[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"

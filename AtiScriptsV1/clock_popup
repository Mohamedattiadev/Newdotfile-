#!/bin/bash

# =============================================================================
#
# UNIFIED DAILY & WEEKLY PLAN NOTIFIER
#
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURATION
# -----------------------------------------------------------------------------
# --- Daily Todo Config ---
TODO_FILE="/home/ati/.config/rofi/Todo_files/todos.md"

# --- Weekly Plan Config ---
PLAN_FILE="/home/ati/.config/rofi/Todo_files/yearly_plan.md"
STATE_FILE="/home/ati/.config/rofi/Todo_files/.plan_start_date"

# -----------------------------------------------------------------------------
# DATE & HEADER SETUP
# -----------------------------------------------------------------------------
today=$(date "+%Y-%m-%d")
header=$(date "+%A, %d %B %Y")
mkdir -p "$(dirname "$TODO_FILE")"
touch "$TODO_FILE"

# =============================================================================
# --- SECTION 1: DAILY TODO SCRIPT LOGIC ---
# =============================================================================

# --- Daily Processing Functions ---
process_tasks() {
	mode="$1"
	awk -v mode="$mode" '
        # Function: deterministic color based on tag name
        function tag_color(tag,   sum, i, c, r, g, b) {
            sum = 0
            for (i=1; i<=length(tag); i++) {
                c = ord(substr(tag,i,1))
                sum += c * i
            }
            r = (sum * 53) % 256
            g = (sum * 97) % 256
            b = (sum * 193) % 256
            return sprintf("#%02X%02X%02X", r, g, b)
        }
        # Function: get ASCII code of character
        function ord(c) { return sprintf("%d", index("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789", c)) }
        {
            prio = 2
            line = $0
            color = ""
            if (match(line, /@Color\([^)]+\)/)) {
                color_tag = substr(line, RSTART, RLENGTH)
                sub(/@Color\([^)]+\)/, "", line)
                color = color_tag
                gsub(/@Color\(|\)/, "", color)
            }
            if (sub(/@Prio\(high\)/, "(High)", line)) { prio = 1 }
            else if (sub(/@Prio\(low\)/, "(Low)", line)) { prio = 3 }
            else if (sub(/@Prio\(normal\)/, "(Normal)", line)) { prio = 2 }
            
            tag_html = ""
            while (match(line, /@Tag\([^)]+\)/)) {
                full_tag = substr(line, RSTART, RLENGTH)
                tag_name = full_tag
                gsub(/@Tag\(|\)/,"",tag_name)
                tag_html = tag_html "<span foreground=\"" tag_color(tag_name) "\">#" tag_name "</span> "
                line = substr(line,1,RSTART-1) substr(line,RSTART+RLENGTH)
            }
            sub(/- \[.?\] */, "", line)
            sub(/ *@([0-9]{4}-[0-9]{2}-[0-9]{2}).*/, "", line)
            gsub(/^[ \t]+|[ \t]+$/, "", line)
            box = (mode=="done") ? "  - [x] " : "  - [  ] "
            final_line = box line " " tag_html
            if (color != "") { final_line = "<span foreground=\"" color "\">" final_line "</span>" }
            print prio "|" final_line
        }' | sort -n | cut -d'|' -f2-
}

highlight_priority() {
	sed -e 's/(High)/<span foreground=\"#FF6B6B\">(High)<\/span>/g' \
		-e 's/(Low)/<span foreground=\"#FFD580\">(Low)<\/span>/g' \
		-e 's/(Normal)/<span foreground=\"#ffffff\">(Normal)<\/span>/g'
}

# --- Gather & Process Daily Tasks ---
due_today=$(grep "\[ \].*@${today}" "$TODO_FILE" | process_tasks "undone" | highlight_priority)
done_today=$(grep "\[x\].*@${today}" "$TODO_FILE" | process_tasks "done" | highlight_priority)
general=$(awk -v d="$today" '/- \[ \] .*@([0-9]{4}-[0-9]{2}-[0-9]{2})/ { match($0, /@([0-9]{4}-[0-9]{2}-[0-9]{2})/, a); if (a[1] < d) print $0; }' "$TODO_FILE" | process_tasks | shuf | head -n 4 | highlight_priority)

future=$(
	awk -v d="$today" '/- \[ \] .*@([0-9]{4}-[0-9]{2}-[0-9]{2})/ {match($0, /@([0-9]{4}-[0-9]{2}-[0-9]{2})/, a);if (a[1] > d) print $0;}' "$TODO_FILE" | process_tasks | shuf | head -n 4 | highlight_priority
)
# =============================================================================
# --- SECTION 2: WEEKLY PLAN SCRIPT LOGIC ---
# =============================================================================

# --- Weekly Reset Functionality ---
if [[ "$1" == "reset" ]]; then
	if [ -f "$STATE_FILE" ]; then
		rm "$STATE_FILE"
		notify-send "Plan Reset" "Weekly plan progress has been reset."
	fi
	exit 0
fi

# --- Calculate Plan Week ---
if [ ! -f "$STATE_FILE" ]; then date "+%Y-%m-%d" >"$STATE_FILE"; fi
start_date=$(cat "$STATE_FILE")
start_seconds=$(date -d "$start_date" +%s)
now_seconds=$(date +%s)
days_passed=$(((now_seconds - start_seconds) / 86400))
weeks_passed=$((days_passed / 7))
plan_week_to_show=$((1 + weeks_passed))

# --- Extract Weekly Tasks ---
target_heading=$(awk -v current_week="$plan_week_to_show" '/^### Week/ {line = $0; gsub(/[^0-9-]+/, "", line); split(line, range, "-"); start_week = range[1]; end_week = (range[2] != "") ? range[2] : start_week; if (current_week >= start_week && current_week <= end_week) {print $0; exit;}}' "$PLAN_FILE")
current_week_block=""
if [ -n "$target_heading" ]; then
	current_week_block=$(awk -v start_pattern="$target_heading" '$0 == start_pattern { printing=1; next } printing && /^###/ { exit } printing' "$PLAN_FILE")
fi

# --- Weekly Processing Function ---

format_weekly_tasks() {
	sed 's/\*\*\([^*]\+\)\*\*/<b>\1<\/b>/g' |
		sed 's/^- \[.\]\s*//; s/^/ ‚Ä¢ /' |
		sed 's/‚Ä¢ \([^:]\+\):/‚Ä¢ <b><span foreground="#E5C07B">\1<\/span><\/b>:/'
}

# --- Process Weekly Tasks ---
weekly_tasks_todo_raw=$(echo "$current_week_block" | grep -- '- \[ \]')
weekly_tasks_done_raw=$(echo "$current_week_block" | grep -- '- \[x\]')
weekly_tasks_todo=$(echo "$weekly_tasks_todo_raw" | format_weekly_tasks)
# weekly_tasks_done=$(echo "$weekly_tasks_done_raw" | format_weekly_tasks)

# =============================================================================
# --- SECTION 3: FINAL NOTIFICATION ASSEMBLY ---
# =============================================================================

# --- Fallbacks for all sections ---
[ -z "$due_today" ] && due_today="<i>  (No tasks due today)</i>"
[ -z "$done_today" ] && done_today="<i>  (No tasks completed today)</i>"
[ -z "$general" ] && general="<i>  (No overdue tasks)</i>"
if [ -z "$current_week_block" ]; then
	weekly_tasks_todo="<i>(No weekly plan found for Week #$plan_week_to_show)</i>"
	weekly_tasks_done=""
else
	[ -z "$weekly_tasks_todo" ] && weekly_tasks_todo="<i>(All weekly tasks are done! üéâ)</i>"
	[ -z "$weekly_tasks_done" ] && weekly_tasks_done="<i>(No weekly tasks completed yet.)</i>"
fi

# # --- Display the Unified Notification ---
# notify-send -u low -h string:markup:1 -t 30000 \
# 	"what is the plan Today?" \
# 	"<b><span foreground='#e5c07b'>$header</span></b>
# <b>--------------------------------------------------------------------</b>
# <b><span foreground='#61afef'>üóìÔ∏è Due Today:</span></b>
# $due_today
# <b><span foreground='#98c379'>‚úÖ Done Today:</span></b>
# $done_today
# <b><span foreground='#e06c75'>üìù Overdue:</span></b>
# $general
# <b>========================================</b>
# <b><span size='large' foreground='#ffffff'>üéØ Weekly Goals (Week #$plan_week_to_show)</span></b>
# <b><span foreground='#61afef'>$weekly_tasks_todo</span></b>
# $weekly_header_done
# <b><span foreground='#98c379'>$weekly_tasks_done</span></b>"
[ -z "$future" ] && future="<i>(No future tasks)</i>"

notify-send -u low -h string:markup:1 -t 40000 \
	"what is the plan Today?" \
	"<b><span foreground='#ffffff'>$header</span></b>
<b><span >-----------------------------------------------------------------------</span></b>
<b><span foreground='#ffffff'>üóìÔ∏è Due Today:</span></b>
<b><span >$due_today</span></b>
<b><span >-----------------------------------------------------------------------</span></b>
<b><span foreground='#c678dd'>‚úÖ Done Today:</span></b>
<b><span foreground='#70D78F'>$done_today</span></b>
<b><span >-----------------------------------------------------------------------</span></b>
<b><span >üìù General (Past Due):</span></b>
<b><span foreground='#ffffff' >$general</span></b>
<b><span >-----------------------------------------------------------------------</span></b>
<b><span >‚è≥ Future Tasks:</span></b>
<b><span foreground='#ffffff' >$future</span></b>
<b><span >-----------------------------------------------------------------------</span></b>
<b><span size='large' foreground='#ffffff'>\t\tüéØ Weekly Goals (Week #$plan_week_to_show)</span></b>

<span  foreground='#abb2bf'>$weekly_tasks_todo</span> <span  foreground='#abb2bf'>$weekly_tasks_done</span>"
